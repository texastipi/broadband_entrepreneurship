---
title: "Entrepreneurship Measurements"
author: "Jaewon R. Choi"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = 'center', warning = FALSE, message = FALSE)
```

Here I will explore different potential entrepreneurship measurements available. In the current dataset, we have several different potential measures of entrepreneurship:

* **Venture Density**: Online venture activities based on GoDaddy database (average of data points available throughout _2018 and 2019_)
* **Percent of County Business Establishment with <=50 Employees**: % of business establishments with less than 50 employees among all business establishments _(County Business Dynamics dataset from 2012,2017,2018)_
* **Percent of County Business Establishment with <=10 Employees**: % of business establishment with less than 10 employees among all business establishments _(County Business Dynamics dataset from 2012,2017,2018)_
* **Percent of Nonfarm Nonemployer Establishments**: % of nonfarm nonemployer establishment among total employments _(Nonemployer Statistics dataset from 2012,2017,2018)_
* **Percent of Nonfarm Proprietors**: % of nonfarm proprietors among total employments _(Bureau of Economic Analysis dataset from 2012,2018)_

Throughout this page, I will explore descriptive statistics of these measures, distributions of the measures, correlations between these measures, and also how these measures look like on the map geographically.

<div style="margin-bottom:30px;">
</div>

## Descriptive Statistics of Broadband Measures

```{r Impoart Libraries, results='hide', echo=FALSE}
library(leaflet)
library(tidyverse)
library(RColorBrewer)
library(tigris)
library(ggplot2)
library(sp)
library(stargazer)
library(gridExtra)

#### Import the merged dataset V2 ####
tx_bb_entrepreneur_merged_v2 <- read_csv("https://raw.githubusercontent.com/texastipi/broadband_entrepreneurship/master/Broadband-Entrepreneurship-TX-merged_v2.csv")

tx_bb_entrepreneur_merged_v2 <- tx_bb_entrepreneur_merged_v2 %>% 
  mutate(chg_pct_50_est_cbp_2012_2018 = pct_50_est_cbp_2018 - pct_50_est_cbp_2012,
         chg_pct_10_est_cbp_2012_2018 = pct_10_est_cbp_2018 - pct_10_est_cbp_2012)

## Set up spatial dataframe
tx_county <- counties("Texas")
tx_bb_entrepreneur_merged_v3 <- sp::merge(tx_county, tx_bb_entrepreneur_merged_v2,
                                          by.x = "GEOID", by.y = "FIPS")
```

```{r Descriptive Statistics, results='asis', echo=FALSE}
#### Descriptive Statistics ####
stargazer(as.data.frame(tx_bb_entrepreneur_merged_v2)[c("pct_50_est_cbp_2018","pct_10_est_cbp_2018","pct_nonfarmneest_nemp_2018","pct_nonfarm_bea_2018","venturedensity_mean")],
          covariate.labels = c("% of Business Establishment (<50 Employees)",
                               "% of Business Establishment (<10 Employees)",
                               "% of Nonfarm Nonemployer",
                               "% of Nonfarm Proprietors",
                               "Average Venture Density"), type = "html",
          align = TRUE, font.size = "Huge", column.sep.width = "2pt")

```

<div style="margin-bottom:30px;">
</div>

## Distributions of Entrepreneurship Measures

<div style="margin-bottom:30px;">
</div>

```{r Distributions of Entrepreneurship Measures, echo=FALSE, cache=TRUE, message=FALSE, fig.retina=2, fig.dim=c(10,7)}
grid.arrange(
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = pct_50_est_cbp_2018)) + geom_histogram() +
    theme_minimal() + theme(axis.text = element_text(size = 11),
                            axis.title = element_text(size = 12, face = "bold")) +
    xlab("% of Establishments\n(<50 Employees, 2018)") + ylab("Frequency") +
    scale_x_continuous(labels = scales::percent, breaks = scales::breaks_pretty()),
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = pct_10_est_cbp_2018)) + geom_histogram() +
    theme_minimal() + theme(axis.text = element_text(size = 11),
                            axis.title = element_text(size = 12, face = "bold")) +
    xlab("% of Establishment\n(<10 Employees, 2018)") + ylab("Frequency") +
    scale_x_continuous(labels = scales::percent, breaks = scales::breaks_pretty()),
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = pct_nonfarmneest_nemp_2018)) + geom_histogram() +
    theme_minimal() + theme(axis.text = element_text(size = 11),
                            axis.title = element_text(size = 12, face = "bold")) +
    xlab("% of Nonfarm\nNonemployer (2018)") + ylab("Frequency") +
    scale_x_continuous(labels = scales::percent, breaks = scales::breaks_pretty()),
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = pct_nonfarm_bea_2018)) + geom_histogram() +
    theme_minimal() + theme(axis.text = element_text(size = 11),
                            axis.title = element_text(size = 12, face = "bold")) +
    xlab("% of Nonfarm\nProprietors (2018)") + ylab("Frequency") +
    scale_x_continuous(labels = scales::percent, breaks = scales::breaks_pretty()),
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = venturedensity_mean)) + geom_histogram() +
    theme_minimal() + theme(axis.text = element_text(size = 11),
                            axis.title = element_text(size = 12, face = "bold")) +
    xlab("Venture Density") + ylab("Frequency") +
    scale_x_continuous(breaks = scales::breaks_pretty()),
  nrow = 2, ncol = 3, top = grid::textGrob("Entrepreneurship Measure Distribution", 
                                           gp = grid::gpar(fontface="bold",fontsize=14))
)
```

<div style="margin-bottom:30px;">
</div>

## Correlations b/w Entrepreneurship Measures

<div style="margin-bottom:30px;">
</div>

### Correlations b/w Traditional Measures

<div style="margin-bottom:20px;">
</div>

```{r Correlation Traditional Entre Measures, echo=FALSE, cache=TRUE, message=FALSE, fig.retina=2, fig.dim=c(15,5)}
grid.arrange(
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = pct_10_est_cbp_2018, y = pct_nonfarmneest_nemp_2018)) + 
    geom_point(color = "grey10", alpha = 0.7, size = 3) + 
    geom_smooth(method = "lm", color = "darkorange3") + theme_minimal() + 
    theme(axis.text = element_text(size = 11), axis.title = element_text(size = 12, face = "bold")) +
    labs(x = "% of Establishment\n(<10 Employees, 2018)", y = "% of Nonfarm\nNonemployer (2018)") +
    scale_x_continuous(labels = scales::percent, breaks = scales::breaks_pretty()) +
    scale_y_continuous(labels = scales::percent, breaks = scales::breaks_pretty()) +
    ggpubr::stat_cor(p.accuracy = 0.001, r.accuracy = 0.01),
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = pct_10_est_cbp_2018, y = pct_nonfarm_bea_2018)) +
    geom_point(color = "grey10", alpha = 0.7, size = 3) + 
    geom_smooth(method = "lm", color = "darkorange3") + theme_minimal() +
    theme(axis.text = element_text(size = 11), axis.title = element_text(size = 12, face = "bold")) +
    labs(x = "% of Establishment\n(<10 Employees, 2018)", y = "% of Nonfarm\nProprietors (2018)") +
    scale_x_continuous(labels = scales::percent, breaks = scales::breaks_pretty()) +
    scale_y_continuous(labels = scales::percent, breaks = scales::breaks_pretty()) +
    ggpubr::stat_cor(p.accuracy = 0.001, r.accuracy = 0.01),
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = pct_nonfarmneest_nemp_2018, y = pct_nonfarm_bea_2018)) +
    geom_point(color = "grey10", alpha = 0.7, size = 3) + 
    geom_smooth(method = "lm", color = "darkorange3") + theme_minimal() +
    theme(axis.text = element_text(size = 11), axis.title = element_text(size = 12, face = "bold")) +
    labs(x = "% of Nonfarm\nNonemployer (2018)", y = "% of Nonfarm\nProprietors (2018)") +
    scale_x_continuous(labels = scales::percent, breaks = scales::breaks_pretty()) +
    scale_y_continuous(labels = scales::percent, breaks = scales::breaks_pretty()) +
    ggpubr::stat_cor(p.accuracy = 0.001, r.accuracy = 0.01),
  nrow = 1, ncol = 3, top = grid::textGrob("Correlations b/w Traditional Entrepreneurship Measures\n",
                                             gp = grid::gpar(fontface="bold",fontsize=14))
  )

```

<div style="margin-bottom:20px;">
</div>

### Correlation b/w Venture Density and Traditional Entrepreneurship Measures

<div style="margin-bottom:20px;">
</div>

```{r Correlation VD-Entre Measures, echo=FALSE, cache=TRUE, message=FALSE, fig.retina=2, fig.dim=c(15,5)}
grid.arrange(
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = pct_10_est_cbp_2018, y = venturedensity_mean)) + 
    geom_point(color = "grey10", alpha = 0.7, size = 3) + 
    geom_smooth(method = "lm", color = "darkorange3") + theme_minimal() + 
    theme(axis.text = element_text(size = 11), axis.title = element_text(size = 12, face = "bold")) +
    labs(x = "% of Establishment\n(<10 Employees, 2018)", y = "Venture Density") +
    scale_x_continuous(labels = scales::percent, breaks = scales::breaks_pretty()) +
    scale_y_continuous(breaks = scales::breaks_pretty()) +
    ggpubr::stat_cor(p.accuracy = 0.001, r.accuracy = 0.01),
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = pct_nonfarmneest_nemp_2018, y = venturedensity_mean)) +
    geom_point(color = "grey10", alpha = 0.7, size = 3) + 
    geom_smooth(method = "lm", color = "darkorange3") + theme_minimal() +
    theme(axis.text = element_text(size = 11), axis.title = element_text(size = 12, face = "bold")) +
    labs(x = "% of Nonfarm\nNonemployer (2018)", y = "Venture Density") +
    scale_x_continuous(labels = scales::percent, breaks = scales::breaks_pretty()) +
    scale_y_continuous(breaks = scales::breaks_pretty()) +
    ggpubr::stat_cor(p.accuracy = 0.001, r.accuracy = 0.01),
  ggplot(tx_bb_entrepreneur_merged_v2, aes(x = pct_nonfarm_bea_2018, y = venturedensity_mean)) +
    geom_point(color = "grey10", alpha = 0.7, size = 3) + 
    geom_smooth(method = "lm", color = "darkorange3") + theme_minimal() +
    theme(axis.text = element_text(size = 11), axis.title = element_text(size = 12, face = "bold")) +
    labs(x = "% of Nonfarm\nProprietors (2018)", y = "Venture Density") +
    scale_x_continuous(labels = scales::percent, breaks = scales::breaks_pretty()) +
    scale_y_continuous(breaks = scales::breaks_pretty()) +
    ggpubr::stat_cor(p.accuracy = 0.001, r.accuracy = 0.01),
  nrow = 1, ncol = 3, top = grid::textGrob("Correlations b/w Venture Density & Traditional Entrepreneurship Measures\n",
                                             gp = grid::gpar(fontface="bold",fontsize=14))
  )

```

<div style="margin-bottom:30px;">
</div>

## Mapping Different Entrepreneurship Measures

<div style="margin-bottom:30px;">
</div>

```{r Map Setup, echo=FALSE, results='hide', cache=TRUE}
## Create continuous color palette function based on FCC broadband range (0~1) ##
pal <- colorNumeric(palette = "YlOrRd", domain = c(0,1))
pal2 <- colorNumeric(palette = "YlOrRd", domain = tx_bb_entrepreneur_merged_v2$venturedensity_mean)

## Set a popup template ##
popup_tx <- paste0("<strong>", tx_bb_entrepreneur_merged_v3$county,
                   "</strong><br />% Sole Proprietor (2017): ", round(tx_bb_entrepreneur_merged_v3$pct_proprietors_employment_2017*100, digits = 1), "%",
                   "<br />Venture Density: ", round(tx_bb_entrepreneur_merged_v3$venturedensity_mean, digits = 1),
                   "<br />Highly Active VD: ", round(tx_bb_entrepreneur_merged_v3$highlyactive_vd_mean, digits = 1),
                   "<br />Total Employment (2018): ", tx_bb_entrepreneur_merged_v3$emp_cbp_2018,
                   "<br />Total # Firms (2017): ", tx_bb_entrepreneur_merged_v3$firm_2017)
head(popup_tx)
## Create a map object ##
map <- leaflet(tx_bb_entrepreneur_merged_v3)
```

<div style="margin-bottom:30px;">
</div>

### Percentage of Business Establishments with less than 10 Employees (2018)

<div style="margin-bottom:30px;">
</div>

```{r 10 Establishment, echo=FALSE, cache=TRUE}
## Establishment with less than 10 employees Map ##
map %>% addTiles() %>% setView(lng = -100.000, lat = 31.000, zoom = 6) %>% 
  addPolygons(stroke = F, smoothFactor = 0.2, fillOpacity = 0.9,
                                   color = ~pal(pct_10_est_cbp_2018),
              popup = ~popup_tx) %>% 
  addLegend("bottomright", pal = pal, values = ~pct_10_est_cbp_2018,
            title = "% of Establishments<br>(<10 Employees)",
            labFormat = labelFormat(suffix = "%", transform = function(x) 100*x), na.label = "N/A", opacity = 1)
```

<div style="margin-bottom:30px;">
</div>

### Percentage of Nonfarm Nonemployer Establishments (2018)

<div style="margin-bottom:30px;">
</div>

```{r Nonfarm Nonemployer Share Map, echo=FALSE, cache=TRUE}
## Nonfarm Nonemployer Share Map ##
map %>% addTiles() %>% setView(lng = -100.000, lat = 31.000, zoom = 6) %>% 
  addPolygons(stroke = F, smoothFactor = 0.2, fillOpacity = 0.9,
              color = ~pal(pct_nonfarmneest_nemp_2018),
              popup = ~popup_tx) %>% 
  addLegend("bottomright", pal = pal, values = ~pct_nonfarmneest_nemp_2018,
            title = "% of Nonfarm<br>Nonemployers (2018)",
            labFormat = labelFormat(suffix = "%", transform = function(x) 100*x), na.label = "N/A",
            opacity = 1)
```

<div style="margin-bottom:30px;">
</div>

### Percentage of Nonfarm Proprietors (2018)

<div style="margin-bottom:30px;">
</div>

```{r Nonfarm Proprietor Share Map, echo=FALSE, cache=TRUE}
## Nonfarm Proprietors Share Map ##
map %>% addTiles() %>% setView(lng = -100.000, lat = 31.000, zoom = 6) %>% 
  addPolygons(stroke = F, smoothFactor = 0.2, fillOpacity = 0.9,
              color = ~pal(pct_nonfarm_bea_2018),
              popup = ~popup_tx) %>% 
  addLegend("bottomright", pal = pal, values = ~pct_nonfarm_bea_2018,
            title = "% of Nonfarm<br>Proprietors (2018)",
            labFormat = labelFormat(suffix = "%", transform = function(x) 100*x), na.label = "N/A",
            opacity = 1)
```

<div style="margin-bottom:30px;">
</div>

### Venture Density in Texas

<div style="margin-bottom:30px;">
</div>

```{r Venture Density, echo=FALSE, cache=TRUE}
## Venture Density Map ##
map %>% addTiles() %>% setView(lng = -100.000, lat = 31.000, zoom = 6) %>% 
  addPolygons(stroke = F, smoothFactor = 0.2, fillOpacity = 0.9,
              color = ~pal2(venturedensity_mean),
              popup = ~popup_tx) %>% 
  addLegend("bottomright", pal = pal2, values = ~venturedensity_mean,
            title = "Venture Density", opacity = 1)
```

<div style="margin-bottom:30px;">
</div>

## Entrepreneurship Measures Trend (2012-2018)

<div style="margin-bottom:30px;">
</div>

In this section, we will inspect the general trend of different traditional entrepreneurship measures over the period from 2012 to 2018.

For the county level charts, **top 7 counties with the most change (i.e., difference b/w maximum and minimum throughout the timeframe)** are highlighted.

```{r Trend chart datasets setup, echo=FALSE, error=FALSE, message=FALSE, cache=TRUE, results='hide'}
#### Exploring Economic Variables related to Entrepreneurship ####
#install.packages("tidycensus")    # tidycensus is great for working with population characteristics, but not all available APIs
#install.packages("censusapi")     # censusapi package allows us to access all available APIs provided by the Census Bureau
#devtools::install_github("jwroycechoi/censusapi")     # A GitHub fork that fixes some issues regarding retrieving NAICS2017 and labels
#install.packages("bea.R")         # Bureau of Economic Analysis data access
library(tidycensus)
library(tidyverse)
library(censusapi)
library(bea.R)
library(ggplot2)
library(gridExtra)


# Add key to .Renviron
Sys.setenv(CENSUS_KEY="9001b546c2d77876a089119664dc25a4235eea37")
# Reload .Renviron
readRenviron("~/.Renviron")
# Check to see that the expected key is output in your R console
Sys.getenv("CENSUS_KEY")

## Get CBP variables from year 2012 to 2018 ##
cbp2012_tx_raw <- getCensus(name = "cbp",
                            vintage = 2012,
                            vars = c("EMP","EMP_F","EMPSZES","EMPSZES_TTL","ESTAB","ESTAB_F","YEAR"),
                            region = "county:*",
                            regionin = "state:48")
cbp2013_tx_raw <- getCensus(name = "cbp",
                        vintage = 2013,
                        vars = c("EMP","EMP_F","EMPSZES","EMPSZES_TTL","ESTAB","ESTAB_F","YEAR"),
                        region = "county:*",
                        regionin = "state:48")
cbp2014_tx_raw <- getCensus(name = "cbp",
                        vintage = 2014,
                        vars = c("EMP","EMP_F","EMPSZES","EMPSZES_TTL","ESTAB","ESTAB_F","YEAR"),
                        region = "county:*",
                        regionin = "state:48")
cbp2015_tx_raw <- getCensus(name = "cbp",
                        vintage = 2015,
                        vars = c("EMP","EMP_F","EMPSZES","EMPSZES_TTL","ESTAB","ESTAB_F","YEAR"),
                        region = "county:*",
                        regionin = "state:48")
cbp2016_tx_raw <- getCensus(name = "cbp",
                        vintage = 2016,
                        vars = c("EMP","EMP_F","EMPSZES","EMPSZES_TTL","ESTAB","ESTAB_F","YEAR"),
                        region = "county:*",
                        regionin = "state:48")
cbp2017_tx_raw <- getCensus(name = "cbp",
                            vintage = 2017,
                            vars = c("EMP","EMP_F","EMPSZES","EMPSZES_LABEL","ESTAB","ESTAB_F","YEAR"),
                            region = "county:*",
                            regionin = "state:48")
cbp2018_tx_raw <- getCensus(name = "cbp",
                            vintage = 2018,
                            vars = c("EMP","EMP_F","EMPSZES","EMPSZES_LABEL","ESTAB","ESTAB_F","YEAR"),
                            region = "county:*",
                            regionin = "state:48")

## Make modifications and aggregate the datasets ##

cbp2012_tx_raw <- cbp2012_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         EMP = as.numeric(EMP),
         ESTAB = as.numeric(ESTAB),
         EMP = case_when(EMP_F == "a" ~ round(median(seq(0,19)), digits = 0),  # For employment range symbols, replace with median of the range
                         EMP_F == "b" ~ round(median(seq(20,99)), digits = 0),
                         EMP_F == "c" ~ round(median(seq(100,249)), digits = 0),
                         EMP_F == "e" ~ round(median(seq(250,499)), digits = 0),
                         EMP_F == "f" ~ round(median(seq(500,999)), digits = 0),
                         EMP_F == "g" ~ round(median(seq(1000,2499)), digits = 0),
                         EMP_F == "h" ~ round(median(seq(2500,4999)), digits = 0),
                         EMP_F == "i" ~ round(median(seq(5000,9999)), digits = 0),
                         EMP_F == "j" ~ round(median(seq(10000,24999)), digits = 0),
                         EMP_F == "k" ~ round(median(seq(25000,49999)), digits = 0),
                         EMP_F == "l" ~ round(median(seq(50000,99999)), digits = 0),
                         EMP_F == "m" ~ 100000,
                         TRUE ~ EMP))
cbp2012_tx <- cbp2012_tx_raw %>% 
  filter(EMPSZES == "001"|EMPSZES == "210"|EMPSZES == "212"|EMPSZES == "220"|EMPSZES == "230"|EMPSZES == "241") %>% 
  mutate(est_total = ifelse(EMPSZES == "001", ESTAB, 0),
         est_50 = ifelse(EMPSZES != "001", ESTAB, 0),
         est_10 = ifelse(EMPSZES == "210"|EMPSZES == "212" | EMPSZES == "220", ESTAB, 0)) %>% 
  group_by(county_FIPS) %>% 
  summarise(emp_cbp = sum(EMP, na.rm = T),
            est_cbp = sum(est_total, na.rm = T),
            est_50_cbp = sum(est_50, na.rm = T),
            est_10_cbp = sum(est_10, na.rm = T),
            year = "2012") %>% 
  mutate(pct_50_est_cbp = est_50_cbp / est_cbp,
         pct_10_est_cbp = est_10_cbp / est_cbp)
  
cbp2013_tx_raw <- cbp2013_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         EMP = as.numeric(EMP),
         ESTAB = as.numeric(ESTAB),
         EMP = case_when(EMP_F == "a" ~ round(median(seq(0,19)), digits = 0),  # For employment range symbols, replace with median of the range
                         EMP_F == "b" ~ round(median(seq(20,99)), digits = 0),
                         EMP_F == "c" ~ round(median(seq(100,249)), digits = 0),
                         EMP_F == "e" ~ round(median(seq(250,499)), digits = 0),
                         EMP_F == "f" ~ round(median(seq(500,999)), digits = 0),
                         EMP_F == "g" ~ round(median(seq(1000,2499)), digits = 0),
                         EMP_F == "h" ~ round(median(seq(2500,4999)), digits = 0),
                         EMP_F == "i" ~ round(median(seq(5000,9999)), digits = 0),
                         EMP_F == "j" ~ round(median(seq(10000,24999)), digits = 0),
                         EMP_F == "k" ~ round(median(seq(25000,49999)), digits = 0),
                         EMP_F == "l" ~ round(median(seq(50000,99999)), digits = 0),
                         EMP_F == "m" ~ 100000,
                         TRUE ~ EMP))
cbp2013_tx <- cbp2013_tx_raw %>% 
  filter(EMPSZES == "001"|
           EMPSZES == "210"|EMPSZES == "212"|EMPSZES == "220"|EMPSZES == "230"|EMPSZES == "241") %>% 
  mutate(est_total = ifelse(EMPSZES == "001", ESTAB, 0),
         est_50 = ifelse(EMPSZES != "001", ESTAB, 0),
         est_10 = ifelse(EMPSZES == "210"|EMPSZES == "212" | EMPSZES == "220", ESTAB, 0)) %>% 
  group_by(county_FIPS) %>% 
  summarise(emp_cbp = sum(EMP, na.rm = T),
            est_cbp = sum(est_total, na.rm = T),
            est_50_cbp = sum(est_50, na.rm = T),
            est_10_cbp = sum(est_10, na.rm = T),
            year = "2013") %>% 
  mutate(pct_50_est_cbp = est_50_cbp / est_cbp,
         pct_10_est_cbp = est_10_cbp / est_cbp)

cbp2014_tx_raw <- cbp2014_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         EMP = as.numeric(EMP),
         ESTAB = as.numeric(ESTAB),
         EMP = case_when(EMP_F == "a" ~ round(median(seq(0,19)), digits = 0),  # For employment range symbols, replace with median of the range
                         EMP_F == "b" ~ round(median(seq(20,99)), digits = 0),
                         EMP_F == "c" ~ round(median(seq(100,249)), digits = 0),
                         EMP_F == "e" ~ round(median(seq(250,499)), digits = 0),
                         EMP_F == "f" ~ round(median(seq(500,999)), digits = 0),
                         EMP_F == "g" ~ round(median(seq(1000,2499)), digits = 0),
                         EMP_F == "h" ~ round(median(seq(2500,4999)), digits = 0),
                         EMP_F == "i" ~ round(median(seq(5000,9999)), digits = 0),
                         EMP_F == "j" ~ round(median(seq(10000,24999)), digits = 0),
                         EMP_F == "k" ~ round(median(seq(25000,49999)), digits = 0),
                         EMP_F == "l" ~ round(median(seq(50000,99999)), digits = 0),
                         EMP_F == "m" ~ 100000,
                         TRUE ~ EMP))
cbp2014_tx <- cbp2014_tx_raw %>% 
  filter(EMPSZES == "001"|
           EMPSZES == "210"|EMPSZES == "212"|EMPSZES == "220"|EMPSZES == "230"|EMPSZES == "241") %>% 
  mutate(est_total = ifelse(EMPSZES == "001", ESTAB, 0),
         est_50 = ifelse(EMPSZES != "001", ESTAB, 0),
         est_10 = ifelse(EMPSZES == "210"|EMPSZES == "212" | EMPSZES == "220", ESTAB, 0)) %>% 
  group_by(county_FIPS) %>% 
  summarise(emp_cbp = sum(EMP, na.rm = T),
            est_cbp = sum(est_total, na.rm = T),
            est_50_cbp = sum(est_50, na.rm = T),
            est_10_cbp = sum(est_10, na.rm = T),
            year = "2014") %>% 
  mutate(pct_50_est_cbp = est_50_cbp / est_cbp,
         pct_10_est_cbp = est_10_cbp / est_cbp)  

cbp2015_tx_raw <- cbp2015_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         EMP = as.numeric(EMP),
         ESTAB = as.numeric(ESTAB),
         EMP = case_when(EMP_F == "a" ~ round(median(seq(0,19)), digits = 0),  # For employment range symbols, replace with median of the range
                         EMP_F == "b" ~ round(median(seq(20,99)), digits = 0),
                         EMP_F == "c" ~ round(median(seq(100,249)), digits = 0),
                         EMP_F == "e" ~ round(median(seq(250,499)), digits = 0),
                         EMP_F == "f" ~ round(median(seq(500,999)), digits = 0),
                         EMP_F == "g" ~ round(median(seq(1000,2499)), digits = 0),
                         EMP_F == "h" ~ round(median(seq(2500,4999)), digits = 0),
                         EMP_F == "i" ~ round(median(seq(5000,9999)), digits = 0),
                         EMP_F == "j" ~ round(median(seq(10000,24999)), digits = 0),
                         EMP_F == "k" ~ round(median(seq(25000,49999)), digits = 0),
                         EMP_F == "l" ~ round(median(seq(50000,99999)), digits = 0),
                         EMP_F == "m" ~ 100000,
                         TRUE ~ EMP))
cbp2015_tx <- cbp2015_tx_raw %>% 
  filter(EMPSZES == "001"|
           EMPSZES == "210"|EMPSZES == "212"|EMPSZES == "220"|EMPSZES == "230"|EMPSZES == "241") %>% 
  mutate(est_total = ifelse(EMPSZES == "001", ESTAB, 0),
         est_50 = ifelse(EMPSZES != "001", ESTAB, 0),
         est_10 = ifelse(EMPSZES == "210"|EMPSZES == "212" | EMPSZES == "220", ESTAB, 0)) %>% 
  group_by(county_FIPS) %>% 
  summarise(emp_cbp = sum(EMP, na.rm = T),
            est_cbp = sum(est_total, na.rm = T),
            est_50_cbp = sum(est_50, na.rm = T),
            est_10_cbp = sum(est_10, na.rm = T),
            year = "2015") %>% 
  mutate(pct_50_est_cbp = est_50_cbp / est_cbp,
         pct_10_est_cbp = est_10_cbp / est_cbp)

cbp2016_tx_raw <- cbp2016_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         EMP = as.numeric(EMP),
         ESTAB = as.numeric(ESTAB),
         EMP = case_when(EMP_F == "a" ~ round(median(seq(0,19)), digits = 0),  # For employment range symbols, replace with median of the range
                         EMP_F == "b" ~ round(median(seq(20,99)), digits = 0),
                         EMP_F == "c" ~ round(median(seq(100,249)), digits = 0),
                         EMP_F == "e" ~ round(median(seq(250,499)), digits = 0),
                         EMP_F == "f" ~ round(median(seq(500,999)), digits = 0),
                         EMP_F == "g" ~ round(median(seq(1000,2499)), digits = 0),
                         EMP_F == "h" ~ round(median(seq(2500,4999)), digits = 0),
                         EMP_F == "i" ~ round(median(seq(5000,9999)), digits = 0),
                         EMP_F == "j" ~ round(median(seq(10000,24999)), digits = 0),
                         EMP_F == "k" ~ round(median(seq(25000,49999)), digits = 0),
                         EMP_F == "l" ~ round(median(seq(50000,99999)), digits = 0),
                         EMP_F == "m" ~ 100000,
                         TRUE ~ EMP)) 
cbp2016_tx <- cbp2016_tx_raw %>% 
  filter(EMPSZES == "001"|
           EMPSZES == "210"|EMPSZES == "212"|EMPSZES == "220"|EMPSZES == "230"|EMPSZES == "241") %>% 
  mutate(est_total = ifelse(EMPSZES == "001", ESTAB, 0),
         est_50 = ifelse(EMPSZES != "001", ESTAB, 0),
         est_10 = ifelse(EMPSZES == "210"|EMPSZES == "212" | EMPSZES == "220", ESTAB, 0)) %>% 
  group_by(county_FIPS) %>% 
  summarise(emp_cbp = sum(EMP, na.rm = T),
            est_cbp = sum(est_total, na.rm = T),
            est_50_cbp = sum(est_50, na.rm = T),
            est_10_cbp = sum(est_10, na.rm = T),
            year = "2016") %>% 
  mutate(pct_50_est_cbp = est_50_cbp / est_cbp,
         pct_10_est_cbp = est_10_cbp / est_cbp)

cbp2017_tx_raw <- cbp2017_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         EMP = as.numeric(EMP),
         ESTAB = as.numeric(ESTAB),
         EMP = case_when(EMP_F == "a" ~ round(median(seq(0,19)), digits = 0),  # For employment range symbols, replace with median of the range
                         EMP_F == "b" ~ round(median(seq(20,99)), digits = 0),
                         EMP_F == "c" ~ round(median(seq(100,249)), digits = 0),
                         EMP_F == "e" ~ round(median(seq(250,499)), digits = 0),
                         EMP_F == "f" ~ round(median(seq(500,999)), digits = 0),
                         EMP_F == "g" ~ round(median(seq(1000,2499)), digits = 0),
                         EMP_F == "h" ~ round(median(seq(2500,4999)), digits = 0),
                         EMP_F == "i" ~ round(median(seq(5000,9999)), digits = 0),
                         EMP_F == "j" ~ round(median(seq(10000,24999)), digits = 0),
                         EMP_F == "k" ~ round(median(seq(25000,49999)), digits = 0),
                         EMP_F == "l" ~ round(median(seq(50000,99999)), digits = 0),
                         EMP_F == "m" ~ 100000,
                         TRUE ~ EMP))
cbp2017_tx <- cbp2017_tx_raw %>% 
  filter(EMPSZES == "001"|
           EMPSZES == "210"|EMPSZES == "212"|EMPSZES == "220"|EMPSZES == "230"|EMPSZES == "241") %>% 
  mutate(est_total = ifelse(EMPSZES == "001", ESTAB, 0),
         est_50 = ifelse(EMPSZES != "001", ESTAB, 0),
         est_10 = ifelse(EMPSZES == "210"|EMPSZES == "212" | EMPSZES == "220", ESTAB, 0)) %>% 
  group_by(county_FIPS) %>% 
  summarise(emp_cbp = sum(EMP, na.rm = T),
            est_cbp = sum(est_total, na.rm = T),
            est_50_cbp = sum(est_50, na.rm = T),
            est_10_cbp = sum(est_10, na.rm = T),
            year = "2017") %>% 
  mutate(pct_50_est_cbp = est_50_cbp / est_cbp,
         pct_10_est_cbp = est_10_cbp / est_cbp)

cbp2018_tx_raw <- cbp2018_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         EMP = as.numeric(EMP),
         ESTAB = as.numeric(ESTAB),
         EMP = case_when(EMP_F == "a" ~ round(median(seq(0,19)), digits = 0),  # For employment range symbols, replace with median of the range
                         EMP_F == "b" ~ round(median(seq(20,99)), digits = 0),
                         EMP_F == "c" ~ round(median(seq(100,249)), digits = 0),
                         EMP_F == "e" ~ round(median(seq(250,499)), digits = 0),
                         EMP_F == "f" ~ round(median(seq(500,999)), digits = 0),
                         EMP_F == "g" ~ round(median(seq(1000,2499)), digits = 0),
                         EMP_F == "h" ~ round(median(seq(2500,4999)), digits = 0),
                         EMP_F == "i" ~ round(median(seq(5000,9999)), digits = 0),
                         EMP_F == "j" ~ round(median(seq(10000,24999)), digits = 0),
                         EMP_F == "k" ~ round(median(seq(25000,49999)), digits = 0),
                         EMP_F == "l" ~ round(median(seq(50000,99999)), digits = 0),
                         EMP_F == "m" ~ 100000,
                         TRUE ~ EMP)) 
cbp2018_tx <- cbp2018_tx_raw %>% 
  filter(EMPSZES == "001"|
           EMPSZES == "210"|EMPSZES == "212"|EMPSZES == "220"|EMPSZES == "230"|EMPSZES == "241") %>% 
  mutate(est_total = ifelse(EMPSZES == "001", ESTAB, 0),
         est_50 = ifelse(EMPSZES != "001", ESTAB, 0),
         est_10 = ifelse(EMPSZES == "210"|EMPSZES == "212" | EMPSZES == "220", ESTAB, 0)) %>% 
  group_by(county_FIPS) %>% 
  summarise(emp_cbp = sum(EMP, na.rm = T),
            est_cbp = sum(est_total, na.rm = T),
            est_50_cbp = sum(est_50, na.rm = T),
            est_10_cbp = sum(est_10, na.rm = T),
            year = "2018") %>% 
  mutate(pct_50_est_cbp = est_50_cbp / est_cbp,
         pct_10_est_cbp = est_10_cbp / est_cbp)

## Aggregate all the percentages by county over 2012 - 2018 ##

cbp_2012_2018 <- bind_rows(cbp2012_tx, cbp2013_tx, cbp2014_tx, cbp2015_tx, cbp2016_tx, cbp2017_tx, cbp2018_tx)
cbp_2012_2018 <- cbp_2012_2018 %>% 
  mutate(county_code = substr(county_FIPS, 3, 5)) %>% 
  left_join(., tigris::list_counties("Texas"), by = "county_code") %>% 
  select(-county_code)

# We can also pivot this dataset into wider form by using pivot_wider()
cbp_county_2012_2018 <- pivot_wider(data = cbp_2012_2018,
                                    id_cols = county_FIPS,
                                    names_from = year,
                                    values_from = c("emp_cbp","est_cbp","est_50_cbp","est_10_cbp",
                                                    "pct_50_est_cbp","pct_10_est_cbp"))
# Summary table for the whole state of Texas
cbp_tx_2012_2018 <- cbp_2012_2018 %>% 
  group_by(year) %>% 
  summarise(emp = sum(emp_cbp),
            est = sum(est_cbp),
            est_50 = sum(est_50_cbp),
            est_10 = sum(est_10_cbp)) %>% 
  mutate(pct_50 = est_50 / est,
         pct_10 = est_10 / est)

#### Nonemployer Statistics ####
## Import data from API ##
nonemp2012_tx_raw <- getCensus(name = "nonemp",
                        vintage = 2012,
                        vars = c("NESTAB","NESTAB_F","NAICS2012","NAICS2012_TTL","SECTOR","YEAR"),
                        region = "county:*",
                        regionin = "state:48")
nonemp2013_tx_raw <- getCensus(name = "nonemp",
                               vintage = 2013,
                               vars = c("NESTAB","NESTAB_F","NAICS2012","NAICS2012_TTL","SECTOR","YEAR"),
                               region = "county:*",
                               regionin = "state:48")
nonemp2014_tx_raw <- getCensus(name = "nonemp",
                               vintage = 2014,
                               vars = c("NESTAB","NESTAB_F","NAICS2012","NAICS2012_TTL","SECTOR","YEAR"),
                               region = "county:*",
                               regionin = "state:48")
nonemp2015_tx_raw <- getCensus(name = "nonemp",
                               vintage = 2015,
                               vars = c("NESTAB","NESTAB_F","NAICS2012","NAICS2012_TTL","SECTOR","YEAR"),
                               region = "county:*",
                               regionin = "state:48")
nonemp2016_tx_raw <- getCensus(name = "nonemp",
                               vintage = 2016,
                               vars = c("NESTAB","NESTAB_F","NAICS2012","NAICS2012_TTL","SECTOR","YEAR"),
                               region = "county:*",
                               regionin = "state:48")
nonemp2017_tx_raw <- getCensus(name = "nonemp",
                        vintage = 2017,
                        vars = c("NESTAB","NESTAB_F","NAICS2017","NAICS2017_TTL","SECTOR","YEAR"),
                        region = "county:*",
                        regionin = "state:48")

nonemp2018_tx_raw <- getCensus(name = "nonemp",
                        vintage = 2018,
                        vars = c("NESTAB","NESTAB_F","NAICS2017","NAICS2017_LABEL","SECTOR"),
                        region = "county:*",
                        regionin = "state:48")

## Adjustment and aggregation ##

nonemp2012_tx_raw <- nonemp2012_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         NESTAB = as.numeric(NESTAB))
nonemp2013_tx_raw <- nonemp2013_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         NESTAB = as.numeric(NESTAB))
nonemp2014_tx_raw <- nonemp2014_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         NESTAB = as.numeric(NESTAB))
nonemp2015_tx_raw <- nonemp2015_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         NESTAB = as.numeric(NESTAB))
nonemp2016_tx_raw <- nonemp2016_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         NESTAB = as.numeric(NESTAB))
nonemp2017_tx_raw <- nonemp2017_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         NESTAB = as.numeric(NESTAB))
nonemp2018_tx_raw <- nonemp2018_tx_raw %>% 
  mutate(county_FIPS = paste(state, county, sep = ""),
         NESTAB = as.numeric(NESTAB))

#### Nonemployer Statistics Aggregation ####
nonemp2012_tx <- nonemp2012_tx_raw %>% 
  mutate(est_total = ifelse(NAICS2012 == "00", NESTAB, 0),
         nonfarm_est_total = ifelse(str_detect(NAICS2012, "^11", negate = TRUE), NESTAB, 0),
         nonfarm_est_total = ifelse(NAICS2012 == "00", 0, nonfarm_est_total)) %>% 
  group_by(SECTOR, county_FIPS) %>% slice(1) %>% ungroup() %>% 
  group_by(county_FIPS) %>% 
  summarise(neest_nemp = sum(est_total, na.rm = T),
            nonfarmneest_nemp = sum(nonfarm_est_total, na.rm = T),
            year = levels(factor(.$YEAR))) %>% 
  mutate(pct_nonfarmneest_nemp = nonfarmneest_nemp / neest_nemp)

nonemp2013_tx <- nonemp2013_tx_raw %>% 
  mutate(est_total = ifelse(NAICS2012 == "00", NESTAB, 0),
         nonfarm_est_total = ifelse(str_detect(NAICS2012, "^11", negate = TRUE), NESTAB, 0),
         nonfarm_est_total = ifelse(NAICS2012 == "00", 0, nonfarm_est_total)) %>% 
  group_by(SECTOR, county_FIPS) %>% slice(1) %>% ungroup() %>% 
  group_by(county_FIPS) %>% 
  summarise(neest_nemp = sum(est_total, na.rm = T),
            nonfarmneest_nemp = sum(nonfarm_est_total, na.rm = T),
            year = levels(factor(.$YEAR))) %>% 
  mutate(pct_nonfarmneest_nemp = nonfarmneest_nemp / neest_nemp)

nonemp2014_tx <- nonemp2014_tx_raw %>% 
  mutate(est_total = ifelse(NAICS2012 == "00", NESTAB, 0),
         nonfarm_est_total = ifelse(str_detect(NAICS2012, "^11", negate = TRUE), NESTAB, 0),
         nonfarm_est_total = ifelse(NAICS2012 == "00", 0, nonfarm_est_total)) %>% 
  group_by(SECTOR, county_FIPS) %>% slice(1) %>% ungroup() %>% 
  group_by(county_FIPS) %>% 
  summarise(neest_nemp = sum(est_total, na.rm = T),
            nonfarmneest_nemp = sum(nonfarm_est_total, na.rm = T),
            year = levels(factor(.$YEAR))) %>% 
  mutate(pct_nonfarmneest_nemp = nonfarmneest_nemp / neest_nemp)

nonemp2015_tx <- nonemp2015_tx_raw %>% 
  mutate(est_total = ifelse(NAICS2012 == "00", NESTAB, 0),
         nonfarm_est_total = ifelse(str_detect(NAICS2012, "^11", negate = TRUE), NESTAB, 0),
         nonfarm_est_total = ifelse(NAICS2012 == "00", 0, nonfarm_est_total)) %>% 
  group_by(SECTOR, county_FIPS) %>% slice(1) %>% ungroup() %>% 
  group_by(county_FIPS) %>% 
  summarise(neest_nemp = sum(est_total, na.rm = T),
            nonfarmneest_nemp = sum(nonfarm_est_total, na.rm = T),
            year = levels(factor(.$YEAR))) %>% 
  mutate(pct_nonfarmneest_nemp = nonfarmneest_nemp / neest_nemp)

nonemp2016_tx <- nonemp2016_tx_raw %>% 
  mutate(est_total = ifelse(NAICS2012 == "00", NESTAB, 0),
         nonfarm_est_total = ifelse(str_detect(NAICS2012, "^11", negate = TRUE), NESTAB, 0),
         nonfarm_est_total = ifelse(NAICS2012 == "00", 0, nonfarm_est_total)) %>% 
  group_by(SECTOR, county_FIPS) %>% slice(1) %>% ungroup() %>% 
  group_by(county_FIPS) %>% 
  summarise(neest_nemp = sum(est_total, na.rm = T),
            nonfarmneest_nemp = sum(nonfarm_est_total, na.rm = T),
            year = levels(factor(.$YEAR))) %>% 
  mutate(pct_nonfarmneest_nemp = nonfarmneest_nemp / neest_nemp)

nonemp2017_tx <- nonemp2017_tx_raw %>% 
  mutate(est_total = ifelse(NAICS2017 == "00", NESTAB, 0),
         nonfarm_est_total = ifelse(str_detect(NAICS2017, "^11", negate = TRUE), NESTAB, 0),
         nonfarm_est_total = ifelse(NAICS2017 == "00", 0, nonfarm_est_total)) %>% 
  group_by(SECTOR, county_FIPS) %>% slice(1) %>% ungroup() %>% 
  group_by(county_FIPS) %>% 
  summarise(neest_nemp = sum(est_total, na.rm = T),
            nonfarmneest_nemp = sum(nonfarm_est_total, na.rm = T),
            year = levels(factor(.$YEAR))) %>% 
  mutate(pct_nonfarmneest_nemp = nonfarmneest_nemp / neest_nemp)

nonemp2018_tx <- nonemp2018_tx_raw %>% 
  mutate(est_total = ifelse(NAICS2017 == "00", NESTAB, 0),
         nonfarm_est_total = ifelse(str_detect(NAICS2017, "^11", negate = TRUE), NESTAB, 0),
         nonfarm_est_total = ifelse(NAICS2017 == "00", 0, nonfarm_est_total)) %>% 
  group_by(SECTOR, county_FIPS) %>% slice(1) %>% ungroup() %>% 
  group_by(county_FIPS) %>% 
  summarise(neest_nemp = sum(est_total, na.rm = T),
            nonfarmneest_nemp = sum(nonfarm_est_total, na.rm = T),
            year = "2018") %>% 
  mutate(pct_nonfarmneest_nemp = nonfarmneest_nemp / neest_nemp)

## Bind all dataset ##

## Aggregate all the percentages by county over 2012 - 2018 ##

nonemp_2012_2018 <- bind_rows(nonemp2012_tx, nonemp2013_tx, nonemp2014_tx, nonemp2015_tx, nonemp2016_tx,
                              nonemp2017_tx, nonemp2018_tx)
nonemp_2012_2018 <- nonemp_2012_2018 %>% 
  mutate(pct_nonfarmneest_nemp = ifelse(is.na(pct_nonfarmneest_nemp) | is.infinite(pct_nonfarmneest_nemp),
                                        NA, pct_nonfarmneest_nemp),
         county_code = substr(county_FIPS, 3, 5)) %>% 
  left_join(., tigris::list_counties("Texas"), by = "county_code") %>% 
  select(-county_code)

# We can also pivot this dataset into wider form by using pivot_wider()
nonemp_county_2012_2018 <- pivot_wider(data = nonemp_2012_2018,
                                    id_cols = county_FIPS,
                                    names_from = year,
                                    values_from = c("neest_nemp","nonfarmneest_nemp","pct_nonfarmneest_nemp"))
# Summary table for the whole state of Texas
nonemp_tx_2012_2018 <- nonemp_2012_2018 %>% 
  group_by(year) %>% 
  summarise(nonemp_est = sum(neest_nemp),
            nonfarmnonemp_est = sum(nonfarmneest_nemp)) %>% 
  mutate(pct_nonfarm_nonemp = nonfarmnonemp_est / nonemp_est)

#### Non-farm Proprietors Statistics ####
## Set up the BEA API ##
beaKey <- "1C5D7A5A-D3C0-4919-8D47-820A118D7A56"

## Get the dataset ##
beaSpecs_10 <- list(
  'UserID' = beaKey,
  'Method' = 'GetData',
  'datasetname' = 'Regional',
  'TableName' = 'CAEMP25N',
  'LineCode' = 10,
  'GeoFips' = 'COUNTY',
  'Year' = '2012,2013,2014,2015,2016,2017,2018'
)

bea_10 <- beaGet(beaSpecs_10, asWide = F)

beaSpecs_40 <- list(
  'UserID' = beaKey,
  'Method' = 'GetData',
  'datasetname' = 'Regional',
  'TableName' = 'CAEMP25N',
  'LineCode' = 40,
  'GeoFips' = 'COUNTY',
  'Year' = '2012,2013,2014,2015,2016,2017,2018'
)

bea_40 <- beaGet(beaSpecs_40, asWide = F)

beaSpecs_60 <- list(
  'UserID' = beaKey,
  'Method' = 'GetData',
  'datasetname' = 'Regional',
  'TableName' = 'CAEMP25N',
  'LineCode' = 60,
  'GeoFips' = 'COUNTY',
  'Year' = '2012,2013,2014,2015,2016,2017,2018'
)

bea_60 <- beaGet(beaSpecs_60, asWide = F)

## Clean, adjust and merge ##

bea_10 <- bea_10 %>% filter(str_detect(GeoFips, "^48")) %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  mutate(GeoName = gsub(",.*$","",GeoName)) %>% 
  rename(totalemp = DataValue,
         county = GeoName)
bea_40 <- bea_40 %>% filter(str_detect(GeoFips, "^48")) %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  mutate(GeoName = gsub(",.*$","",GeoName)) %>% 
  rename(proprietors = DataValue,
         county = GeoName)
bea_60 <- bea_60 %>% filter(str_detect(GeoFips, "^48")) %>% 
  select(GeoFips, TimePeriod, DataValue, GeoName) %>% 
  mutate(GeoName = gsub(",.*$","",GeoName)) %>% 
  rename(nonfarm_proprietors = DataValue,
         county = GeoName)

bea_prop <- bea_10 %>% 
  left_join(., select(bea_40, proprietors, TimePeriod, GeoFips), by = c("GeoFips" = "GeoFips", "TimePeriod" = "TimePeriod")) %>% 
  left_join(., select(bea_60, nonfarm_proprietors, TimePeriod, GeoFips), by = c("GeoFips" = "GeoFips", "TimePeriod" = "TimePeriod")) %>% 
  mutate(pct_prop_emp = proprietors / totalemp,
         pct_nonfarm_prop_emp = nonfarm_proprietors / totalemp) %>% 
  rename(year = TimePeriod,
         county_FIPS = GeoFips)

# Table for the entire state of Texas #
bea_tx_prop <- bea_prop %>% 
  group_by(year) %>% 
  summarise(totalemp = sum(totalemp),
            proprietors = sum(proprietors),
            nonfarm_proprietors = sum(nonfarm_proprietors)) %>% 
  mutate(pct_prop_emp = proprietors / totalemp,
         pct_nonfarm_prop_emp = nonfarm_proprietors / totalemp)


```

<div style="margin-bottom:30px;">
</div>

### Business Establishments in Texas (2012-2018)

<div style="margin-bottom:30px;">
</div>

```{r Plot Business Establishments, echo=FALSE, fig.retina=2, fig.dim=c(8,5)}
cbp_tx_est_2012_2018.m <- melt(setDT(cbp_tx_2012_2018), id = "year", measure.vars = 3:5)

ggplot(cbp_tx_est_2012_2018.m, aes(year, value, group = variable, color = variable)) + geom_line(size = 1.3) + 
  geom_point(size = 4) + geom_point(size = 2.5, color = "white") + 
  theme_minimal() + theme(plot.title = element_text(face = "bold", size = 14),
                          plot.subtitle = element_text(size = 9, face = "italic"),
                          axis.text = element_text(size = 11),
                          axis.title = element_text(size = 12, face = "bold")) +
  labs(title = "Business Establishments in Texas (2012-2018)", subtitle = "Source: County Business Patterns (Census Bureau)",
       x = "Year", y = "# of Business", color = "Colors") + 
  scale_y_continuous(limits = c(min(cbp_tx_est_2012_2018.m$value),max(cbp_tx_est_2012_2018.m$value)),
                     labels = function(l){trans = l / 1000; paste0(trans, "K")},
                     breaks = scales::breaks_pretty()) +
  scale_color_manual(labels = c("All Establishment","<50 Employee","<10 Employee"),
                     values = c("red4","royalblue4","seagreen"))

```

<div style="margin-bottom:30px;">
</div>

### Percentage of Business Establishments with less than 50 Employees in Texas Counties (2012-2018)

<div style="margin-bottom:30px;">
</div>

```{r Plot 50 Business County, echo=FALSE, fig.retina=2, fig.dim=c(8,5)}
ggplot(cbp_2012_2018, aes(year, pct_50_est_cbp, group = county_FIPS, color = county_FIPS)) + 
  geom_line(size = 1) + geom_point(size = 2) +
  theme_minimal() + theme(plot.title = element_text(face = "bold", size = 14),
                          plot.subtitle = element_text(size = 9, face = "italic"),
                          legend.position = "none",
                          axis.text = element_text(size = 11),
                          axis.title = element_text(size = 12, face = "bold")) +
  labs(title = "% of Establishments with <50 Employees (2012-2018)", subtitle = "Source: County Business Patterns (Census Bureau)",
       x = "Year", y = "%") + 
  gghighlight(max(max(pct_50_est_cbp, na.rm = T) - min(pct_50_est_cbp, na.rm = T)),
              max_highlight = 7L,
              label_key = county,
              unhighlighted_params = list(size = 0.5, color = alpha("grey", 0.3))) +
  scale_y_continuous(limits = c(0,1),
                     labels = scales::percent,
                     breaks = scales::breaks_pretty()) +
  scale_color_brewer(palette = "Set2")

```

<div style="margin-bottom:30px;">
</div>

### Percentage of Business Establishments with less than 10 Employees in Texas Counties (2012-2018)

<div style="margin-bottom:30px;">
</div>

```{r Plot 10 Business County, echo=FALSE, fig.retina=2, fig.dim=c(8,5)}
ggplot(cbp_2012_2018, aes(year, pct_10_est_cbp, group = county_FIPS, color = county_FIPS)) + 
  geom_line(size = 1, alpha = 0.3) + geom_point(size = 2) +
  theme_minimal() + theme(plot.title = element_text(face = "bold", size = 14),
                          plot.subtitle = element_text(size = 9, face = "italic"),
                          legend.position = "none",
                          axis.text = element_text(size = 11),
                          axis.title = element_text(size = 12, face = "bold")) +
  gghighlight(max(max(pct_10_est_cbp, na.rm = T) - min(pct_10_est_cbp, na.rm = T)),
              max_highlight = 7L,
              label_key = county,
              unhighlighted_params = list(size = 0.5, color = alpha("grey", 0.3))) +
  labs(title = "% of Establishments with <10 Employees (2012-2018)", subtitle = "Source: County Business Patterns (Census Bureau)",
       x = "Year", y = "%") + 
  scale_y_continuous(limits = c(0,1),
                     labels = scales::percent,
                     breaks = scales::breaks_pretty()) +
  scale_color_brewer(palette = "Set2")

```

<div style="margin-bottom:30px;">
</div>

### Percentage of Nonfarm Nonemployers in Texas Counties (2012-2018)

<div style="margin-bottom:30px;">
</div>

```{r Plot Nonemp County, echo=FALSE, fig.retina=2, fig.dim=c(8,5)}
ggplot(nonemp_tx_2012_2018, aes(x = year, y = pct_nonfarm_nonemp, group = 1)) +
  geom_line(size = 1.5, color = "royalblue4") + geom_point(size = 4, color = "royalblue4") + geom_point(size = 2.5, color = "white") +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(face = "italic", size = 9),
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12, face = "bold")) +
  labs(title = "% of Non-farm Nonemployer Establishments in Texas (2012-2018)",
       subtitle = "Source: Nonemployer Statistics (Census Bureau)",
       x = "Year", y = "%") +
  scale_y_continuous(limits = c(0.7,1),
                     labels = scales::percent,
                     breaks = scales::breaks_pretty())

library(gghighlight)

ggplot(nonemp_2012_2018, aes(x = year, y = pct_nonfarmneest_nemp,
                                                   group = county_FIPS, color = county_FIPS)) +
  geom_line(size = 1) + geom_point(size = 2) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(face = "italic", size = 9),
        legend.position = "none",
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12, face = "bold")) +
  labs(title = "% of Non-farm Nonemployer Establishments in Texas Counties (2012-2018)",
       subtitle = "Source: Nonemployer Statistics (Census Bureau)",
       x = "Year", y = "%") +
  gghighlight(max(max(pct_nonfarmneest_nemp, na.rm = T) - min(pct_nonfarmneest_nemp, na.rm = T)),
              max_highlight = 7L,
              label_key = county,
              unhighlighted_params = list(size = 0.5, color = alpha("grey", 0.3))) +
  scale_y_continuous(limits = c(0.1,1),
                     labels = scales::percent,
                     breaks = scales::breaks_pretty()) + 
  scale_color_brewer(palette = "Set2")
```

<div style="margin-bottom:30px;">
</div>

### Percentage of Nonfarm Proprietors in Texas Counties (2012-2018)

<div style="margin-bottom:30px;">
</div>

```{r Plot Proprietors County, echo=FALSE, fig.retina=2, fig.dim=c(8,5)}
bea_tx_prop.m <- melt(setDT(bea_tx_prop), id = "year", measure.vars = 5:6)

ggplot(bea_tx_prop.m, aes(year, value, group = variable, color = variable)) + geom_line(size = 1.3) + 
  geom_point(size = 4) + geom_point(size = 2.5, color = "white") + 
  theme_minimal() + theme(plot.title = element_text(face = "bold", size = 14),
                          plot.subtitle = element_text(size = 9, face = "italic"),
                          axis.text = element_text(size = 11),
                          axis.title = element_text(size = 12, face = "bold")) +
  labs(title = "Share of Proprietors/Non-farm Proprietors in Texas (2012-2018)",
       subtitle = "Source: Bureau of Economic Analysis",
       x = "Year", y = "%", color = "Colors") + 
  scale_y_continuous(limits = c(min(bea_tx_prop.m$value),max(bea_tx_prop.m$value)),
                     labels = scales::percent,
                     breaks = scales::breaks_pretty()) +
  scale_color_manual(labels = c("% of Proprietors\nover total employment","% of Nonfarm Proprietors\nover total employment"),
                     values = c("red4","royalblue4"))

ggplot(bea_prop, aes(x = year, y = pct_nonfarm_prop_emp,
                                             group = county_FIPS, color = county_FIPS)) +
  geom_line(size = 1) + geom_point(size = 2) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(face = "italic", size = 9),
        legend.position = "none",
        axis.text = element_text(size = 11),
        axis.title = element_text(size = 12, face = "bold")) +
  labs(title = "% of Nonfarm Proprietors in Texas Counties (2012-2018)",
       subtitle = "Source: Bureau of Economic Analysis",
       x = "Year", y = "%") +
  gghighlight(max(max(pct_nonfarm_prop_emp, na.rm = T) - min(pct_nonfarm_prop_emp, na.rm = T)),
              max_highlight = 7L,
              label_key = county,
              unhighlighted_params = list(size = 0.5, color = alpha("grey", 0.3))) +
  scale_y_continuous(labels = scales::percent,
                     breaks = scales::breaks_pretty()) + 
  scale_color_brewer(palette = "Set2")
```

